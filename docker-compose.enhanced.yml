version: '3.8'

services:
  # =====================================
  # Core Services
  # =====================================
  
  # Enhanced FastAPI Application
  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: agentic-rag-api
    ports:
      - "8000:8000"
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - HUGGINGFACE_API_KEY=${HUGGINGFACE_API_KEY}
      - DATABASE_URL=postgresql://raguser:ragpass@postgres:5432/ragdb
      - REDIS_URL=redis://redis:6379/0
      - MONGODB_URL=mongodb://raguser:ragpass@mongodb:27017/ragdb
      - QDRANT_URL=http://qdrant:6333
      - MILVUS_HOST=milvus
      - MILVUS_PORT=19530
      - DEVICE=${DEVICE:-cuda}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      - ./data:/app/data
      - ./models:/app/models
      - ./indices:/app/indices
      - ./cache:/app/cache
      - ./logs:/app/logs
      - ./uploads:/app/uploads
      - ./config.yaml:/app/config.yaml:ro
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      mongodb:
        condition: service_healthy
    networks:
      - rag-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
  
  # =====================================
  # Databases
  # =====================================
  
  # PostgreSQL for metadata and structured data
  postgres:
    image: pgvector/pgvector:pg16
    container_name: agentic-rag-postgres
    environment:
      - POSTGRES_USER=raguser
      - POSTGRES_PASSWORD=ragpass
      - POSTGRES_DB=ragdb
      - POSTGRES_EXTENSIONS=vector,pg_trgm,uuid-ossp
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-scripts/postgres:/docker-entrypoint-initdb.d:ro
    ports:
      - "5432:5432"
    networks:
      - rag-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U raguser -d ragdb"]
      interval: 10s
      timeout: 5s
      retries: 5
  
  # Redis for caching and job queues
  redis:
    image: redis:7-alpine
    container_name: agentic-rag-redis
    command: redis-server --maxmemory 2gb --maxmemory-policy allkeys-lru --appendonly yes
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - rag-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
  
  # MongoDB for document storage
  mongodb:
    image: mongo:7.0
    container_name: agentic-rag-mongodb
    environment:
      - MONGO_INITDB_ROOT_USERNAME=raguser
      - MONGO_INITDB_ROOT_PASSWORD=ragpass
      - MONGO_INITDB_DATABASE=ragdb
    volumes:
      - mongodb_data:/data/db
      - ./init-scripts/mongodb:/docker-entrypoint-initdb.d:ro
    ports:
      - "27017:27017"
    networks:
      - rag-network
    restart: unless-stopped
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5
  
  # =====================================
  # Vector Databases
  # =====================================
  
  # Qdrant vector database
  qdrant:
    image: qdrant/qdrant:latest
    container_name: agentic-rag-qdrant
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant_data:/qdrant/storage
    environment:
      - QDRANT__SERVICE__GRPC_PORT=6334
    networks:
      - rag-network
    restart: unless-stopped
  
  # Milvus vector database (alternative)
  milvus-etcd:
    image: quay.io/coreos/etcd:v3.5.5
    container_name: agentic-rag-milvus-etcd
    environment:
      - ETCD_AUTO_COMPACTION_MODE=revision
      - ETCD_AUTO_COMPACTION_RETENTION=1000
      - ETCD_QUOTA_BACKEND_BYTES=4294967296
      - ETCD_SNAPSHOT_COUNT=50000
    volumes:
      - milvus_etcd:/etcd
    command: etcd -advertise-client-urls=http://127.0.0.1:2379 -listen-client-urls http://0.0.0.0:2379 --data-dir /etcd
    networks:
      - rag-network
    restart: unless-stopped
  
  milvus-minio:
    image: minio/minio:RELEASE.2023-03-20T20-16-18Z
    container_name: agentic-rag-milvus-minio
    environment:
      MINIO_ACCESS_KEY: minioadmin
      MINIO_SECRET_KEY: minioadmin
    volumes:
      - milvus_minio:/minio_data
    command: minio server /minio_data --console-address ":9001"
    networks:
      - rag-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3
  
  milvus:
    image: milvusdb/milvus:v2.3.0
    container_name: agentic-rag-milvus
    command: ["milvus", "run", "standalone"]
    environment:
      ETCD_ENDPOINTS: milvus-etcd:2379
      MINIO_ADDRESS: milvus-minio:9000
    volumes:
      - milvus_data:/var/lib/milvus
    ports:
      - "19530:19530"
      - "9091:9091"
    networks:
      - rag-network
    depends_on:
      - milvus-etcd
      - milvus-minio
    restart: unless-stopped
  
  # Weaviate vector database (another alternative)
  weaviate:
    image: semitechnologies/weaviate:latest
    container_name: agentic-rag-weaviate
    ports:
      - "8080:8080"
    environment:
      QUERY_DEFAULTS_LIMIT: 25
      AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED: 'true'
      PERSISTENCE_DATA_PATH: '/var/lib/weaviate'
      DEFAULT_VECTORIZER_MODULE: 'text2vec-transformers'
      ENABLE_MODULES: 'text2vec-transformers,text2vec-openai'
      TRANSFORMERS_INFERENCE_API: 'http://t2v-transformers:8080'
      CLUSTER_HOSTNAME: 'weaviate'
    volumes:
      - weaviate_data:/var/lib/weaviate
    networks:
      - rag-network
    restart: unless-stopped
  
  # Text2Vec transformer for Weaviate
  t2v-transformers:
    image: semitechnologies/transformers-inference:sentence-transformers-all-MiniLM-L6-v2
    container_name: agentic-rag-t2v
    environment:
      ENABLE_CUDA: '1'
    networks:
      - rag-network
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
  
  # =====================================
  # Background Jobs & Processing
  # =====================================
  
  # Celery worker for background tasks
  celery-worker:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: agentic-rag-celery-worker
    command: celery -A agentic_rag.tasks worker --loglevel=info --concurrency=4
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - DATABASE_URL=postgresql://raguser:ragpass@postgres:5432/ragdb
    volumes:
      - ./data:/app/data
      - ./models:/app/models
      - ./logs:/app/logs
    depends_on:
      - redis
      - postgres
    networks:
      - rag-network
    restart: unless-stopped
    deploy:
      replicas: 2
  
  # Celery beat for scheduled tasks
  celery-beat:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: agentic-rag-celery-beat
    command: celery -A agentic_rag.tasks beat --loglevel=info
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
    depends_on:
      - redis
    networks:
      - rag-network
    restart: unless-stopped
  
  # Flower for Celery monitoring
  flower:
    image: mher/flower:latest
    container_name: agentic-rag-flower
    command: celery flower --broker=redis://redis:6379/0 --port=5555
    ports:
      - "5555:5555"
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
      - FLOWER_BASIC_AUTH=admin:admin
    depends_on:
      - redis
    networks:
      - rag-network
    restart: unless-stopped
  
  # =====================================
  # Model Serving
  # =====================================
  
  # Ollama for local LLM serving
  ollama:
    image: ollama/ollama:latest
    container_name: agentic-rag-ollama
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama
    networks:
      - rag-network
    restart: unless-stopped
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
  
  # vLLM for high-performance inference
  vllm:
    image: vllm/vllm-openai:latest
    container_name: agentic-rag-vllm
    ports:
      - "8001:8000"
    volumes:
      - ./models:/models
    environment:
      - HF_TOKEN=${HUGGINGFACE_API_KEY}
    command: --model mistralai/Mistral-7B-Instruct-v0.2 --tensor-parallel-size 1
    networks:
      - rag-network
    restart: unless-stopped
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
  
  # =====================================
  # Monitoring & Observability
  # =====================================
  
  # Prometheus for metrics
  prometheus:
    image: prom/prometheus:latest
    container_name: agentic-rag-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    networks:
      - rag-network
    restart: unless-stopped
  
  # Grafana for visualization
  grafana:
    image: grafana/grafana:latest
    container_name: agentic-rag-grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_INSTALL_PLUGINS=redis-datasource,vertamedia-clickhouse-datasource
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_NAME=Main Org.
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Viewer
    volumes:
      - grafana_data:/var/lib/grafana
      - ./monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./monitoring/grafana/datasources:/etc/grafana/provisioning/datasources:ro
    depends_on:
      - prometheus
    networks:
      - rag-network
    restart: unless-stopped
  
  # Loki for log aggregation
  loki:
    image: grafana/loki:latest
    container_name: agentic-rag-loki
    ports:
      - "3100:3100"
    volumes:
      - ./monitoring/loki-config.yaml:/etc/loki/local-config.yaml:ro
      - loki_data:/loki
    command: -config.file=/etc/loki/local-config.yaml
    networks:
      - rag-network
    restart: unless-stopped
  
  # Promtail for log shipping
  promtail:
    image: grafana/promtail:latest
    container_name: agentic-rag-promtail
    volumes:
      - ./monitoring/promtail-config.yaml:/etc/promtail/config.yml:ro
      - /var/log:/var/log:ro
      - ./logs:/app/logs:ro
    command: -config.file=/etc/promtail/config.yml
    networks:
      - rag-network
    restart: unless-stopped
  
  # Jaeger for distributed tracing
  jaeger:
    image: jaegertracing/all-in-one:latest
    container_name: agentic-rag-jaeger
    environment:
      - COLLECTOR_ZIPKIN_HOST_PORT=:9411
    ports:
      - "5775:5775/udp"
      - "6831:6831/udp"
      - "6832:6832/udp"
      - "5778:5778"
      - "16686:16686"
      - "14268:14268"
      - "14250:14250"
      - "9411:9411"
    networks:
      - rag-network
    restart: unless-stopped
  
  # =====================================
  # Web UI & Frontend
  # =====================================
  
  # Nginx reverse proxy
  nginx:
    image: nginx:alpine
    container_name: agentic-rag-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - ./frontend/dist:/usr/share/nginx/html:ro
    depends_on:
      - api
    networks:
      - rag-network
    restart: unless-stopped
  
  # Streamlit UI (optional)
  streamlit:
    build:
      context: .
      dockerfile: Dockerfile.streamlit
    container_name: agentic-rag-streamlit
    ports:
      - "8501:8501"
    environment:
      - API_URL=http://api:8000
    volumes:
      - ./ui:/app/ui
    depends_on:
      - api
    networks:
      - rag-network
    restart: unless-stopped
  
  # Gradio UI (optional)
  gradio:
    build:
      context: .
      dockerfile: Dockerfile.gradio
    container_name: agentic-rag-gradio
    ports:
      - "7860:7860"
    environment:
      - API_URL=http://api:8000
    volumes:
      - ./gradio_ui:/app/gradio_ui
    depends_on:
      - api
    networks:
      - rag-network
    restart: unless-stopped
  
  # =====================================
  # Development Tools
  # =====================================
  
  # Jupyter for experimentation
  jupyter:
    image: jupyter/pytorch-notebook:latest
    container_name: agentic-rag-jupyter
    ports:
      - "8888:8888"
    environment:
      - JUPYTER_ENABLE_LAB=yes
      - JUPYTER_TOKEN=ragdev
    volumes:
      - ./notebooks:/home/jovyan/work
      - ./data:/home/jovyan/data
      - ./models:/home/jovyan/models
    networks:
      - rag-network
    restart: unless-stopped
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
  
  # MinIO for S3-compatible storage
  minio:
    image: minio/minio:latest
    container_name: agentic-rag-minio
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    volumes:
      - minio_data:/data
    command: server /data --console-address ":9001"
    networks:
      - rag-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3

# =====================================
# Networks
# =====================================

networks:
  rag-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

# =====================================
# Volumes
# =====================================

volumes:
  postgres_data:
  redis_data:
  mongodb_data:
  qdrant_data:
  milvus_data:
  milvus_etcd:
  milvus_minio:
  weaviate_data:
  ollama_data:
  prometheus_data:
  grafana_data:
  loki_data:
  minio_data:
